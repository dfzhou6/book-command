# 锁机制

## 二阶段提交行锁
```
由于行锁的提交是等事务commit才释放，所以一般在做并发业务
时，因尽量将容易发生并发修改的语句放最后，因为就算是并发锁
住，由于并发语句执行完后就commit，所以锁等待时间最短。
```

## innodb锁
1. 分表锁、行锁，MySIAM只支持表锁，而Innodb支持到行锁
2. 意向锁：当对行加锁时，会在表层面加意向锁，所以当加表锁时，可以避免对表的所有行锁进行检查。
2. 行锁又分：共享锁、排他锁、记录锁、间隙锁、next-key锁
3. 共享锁：可以重复加共享锁，但共享锁与排它锁互斥
4. 排它锁：不允许加共享和排查锁
5. 记录锁：表示对当前的行加锁，一般是指有唯一索引、主键
6. 间隙锁
    ```
    - 可重复读才存在间隙锁
    - 间隙锁只有在进行范围查找时，或者查不到数据时，或者非唯一索引才有
    - 可避免幻读
    - 容易带来死锁，因为如果2个相同的并发事务，先select for update，不存在再insert，此时2个insert会都会被对方的间隙锁锁住，造成死锁
    - 解决方案，通过分布式锁，或者尽量使用唯一键，或者使用读已提交。
    ```
7. nextkey：是对二级非唯一索引起作用，比如存在1，3，5，三条记录，查询3时，会对(1,3]+(3,5)加上nextkey锁，即间隙锁是前开后闭(]
8. 幻读：即同一个事务前后两次相同条件的查询，后一次查询查到了前一次查询没有的数据。注意，当前读才会产生幻读，即select * for update，或者更新语句。

